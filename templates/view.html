{% extends 'layouts/layout.html' %}
{% block content %}
{% include 'partials/header.html' %}
{{ text | safe }}
<div class="lines">
    {% for line in range(1, lines + 1) %}
        <a href="#{{ line }}" id="{{ line }}" data-line="{{ line }}" class="line line-{{ line }} {{ 'highlighted' if highlighted and line|string in highlighted }}">{{ line }}</a><br>
    {% endfor %}
</div>
{% endblock %}
{% block bottom_scripts %}
<script>
(() => {
    function addLineToParams(params, line) {
        if (!params.has('h')) {
            params.set('h', line);
        } else {
            const arr = params.get('h').split(',');
            if (arr.indexOf(line) !== -1) {
                return;
            }
            arr.push(line);
            params.set('h', arr.join(','));
        }
    }

    function removeLineFromParams(params, line) {
        if (params.has('h')) {
            params.set(
                'h',
                params.get('h').split(',').filter(i => i !== line).join(',')
            );
        }
    }

    function clickHandler(e) {
        e.preventDefault();

        const el = e.target;
        const line = el.dataset.line;
        const params = new URLSearchParams(document.location.search);
        let hash = window.location.hash;

        if (e.shiftKey) {
            if (hash !== '#' + line) {
                console.log(line);
                el.classList.add('highlighted');
                el.classList.remove('unhighlighted');
                addLineToParams(params, line);
            }
        } else {
            if (hash == '#' + line) {
                hash = '';
                el.classList.remove('highlighted');
                el.classList.add('unhighlighted');
            } else if (el.classList.contains('highlighted')) {
                el.classList.remove('highlighted');
                el.classList.add('unhighlighted');
                removeLineFromParams(params, line);
            } else {
                const prevEl = document.getElementById(hash.substring(1));
                hash = '#' + line;
                el.classList.add('highlighted');
                el.classList.remove('unhighlighted');
                if (prevEl) {
                    prevEl.classList.remove('highlighted');
                    prevEl.classList.add('unhighlighted');
                }
            }
        }

        if (params.get('h') === '') {
            params.delete('h');
        }
        const paramsString = params.toString();
        const newUrl = 
            window.location.protocol +
            '//' +
            window.location.host +
            window.location.pathname +
            (paramsString === '' ? '' : '?' + paramsString) +
            hash;

        history.replaceState({ path: newUrl }, '', newUrl);
    }

    const lines = document.querySelectorAll('.line');
    lines.forEach((line) => {
        line.addEventListener('click', clickHandler)
    });
})();
</script>
{% endblock %}