{% extends 'layouts/layout.html' %}
{% block content %}
{% include 'partials/header.html' %}
{{ text | safe }}
<div class="lines">
    {% for line in range(1, lines + 1) %}
        <span id="{{ line }}" data-line="{{ line }}" class="line line-{{ line }} {{ 'highlighted' if highlighted and line|string in highlighted }}">{{ line }}</span><br>
    {% endfor %}
</div>
{% endblock %}
{% block bottom_scripts %}
<script>
(() => {
    function clickHandler(e) {
        e.target.classList.toggle('highlighted');
        const line = e.target.dataset.line;
        const params = new URLSearchParams(document.location.search);
        const h = params.get('h');
        if (h) {
            let highlighted = h.split(',');
            const i = highlighted.indexOf(line);
            if (i === -1) {
                highlighted.push(line);
            } else {
                highlighted = highlighted.filter((_, n) => n !== i);
            }
            params.set('h', highlighted.join(','));
        } else {
            params.set('h', line);
        }
        const newUrl = window.location.protocol + '//' + window.location.host + window.location.pathname + '?' + params.toString();
        history.replaceState({ path: newUrl }, '', newUrl);
    }

    const lines = document.querySelectorAll('.line');
    lines.forEach((line) => {
        line.addEventListener('click', clickHandler)
    });
})();
</script>
{% endblock %}